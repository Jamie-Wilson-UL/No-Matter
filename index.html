<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>No Matter Blaster</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
  <style>
    body {
      text-align: center;
      background-color: black;
      color: white;
      font-family: 'Press Start 2P', monospace;
      overflow: hidden;
    }
    canvas {
      border: 8px solid #00ff00;
      border-radius: 10px;
      box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00, 0 0 60px #00ff00, 0 0 80px #00ff00;
      display: block;
      margin: 20px auto;
      background-color: #000;
    }
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    @keyframes breathing {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes fill {
      0%   { width: 0; }
      100% { width: 100%; }
    }
    #title-img {
      animation: breathing 3s infinite;
    }

    /* LOADING SCREEN */
    #loading-bar-container {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: black;
    }
    #loading-bar {
      width: 50%;
      height: 30px;
      background-color: white;
      border: 3px solid #00ff00;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #loading-progress {
      height: 100%;
      width: 0;
      background-color: #00ff00;
      /* 5s fill animation */
      animation: fill 5s linear forwards;
    }
    #loading-text {
      font-size: 24px;
      font-family: 'Press Start 2P', monospace;
      color: white;
      font-weight: bold;
      margin-bottom: 20px;
    }
    /* Hidden until 5s pass */
    #press-space-text {
      display: none;
      font-family: 'Press Start 2P', monospace;
      font-size: 20px;
      color: white;
      margin-top: 20px;
    }

    /* HIGH SCORE MODAL */
    #high-score-modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      color: white;
      font-family: 'Press Start 2P', monospace;
    }
    #high-score-modal-content {
      background-color: black;
      margin: 15% auto;
      padding: 20px;
      border: 3px solid #00ff00;
      width: 80%; max-width: 400px;
      text-align: center;
    }
    #player-name {
      width: 80%;
      height: 40px;
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      margin-bottom: 10px;
    }
    #submit-name {
      width: 80%;
      height: 40px;
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      background-color: #00ff00;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body onload="brython()">
  <!-- LOADING SCREEN -->
  <div id="loading-bar-container">
    <div id="loading-text">Loading...</div>
    <div id="loading-bar">
      <div id="loading-progress"></div>
    </div>
    <p id="press-space-text">Press SPACE to Continue</p>
  </div>

  <!-- GAME CANVAS -->
  <canvas id="game-canvas" width="800" height="600" style="display:none;"></canvas>

  <!-- AUDIO -->
  <audio id="title-audio"  src="title_audio.mp3"  loop></audio>
  <audio id="level1-audio" src="level1_audio.mp3" loop></audio>
  <audio id="level2-audio" src="level2_audio.mp3" loop></audio>
  <audio id="level3-audio" src="level3_audio.mp3" loop></audio>
  <audio id="boss-audio"   src="boss_audio.mp3"   loop></audio>

  <!-- SFX -->
  <audio id="laser-audio"     src="laser.mp3"></audio>
  <audio id="explosion-audio" src="explosion.mp3"></audio>

  <!-- TITLE IMAGE -->
  <img id="title-img" src="title.gif" style="display:none"/>

  <!-- HIGH SCORE MODAL -->
  <div id="high-score-modal">
    <div id="high-score-modal-content">
      <p>New High Score! Enter your name:</p>
      <input type="text" id="player-name"/>
      <button id="submit-name">Submit</button>
    </div>
  </div>

  <script type="text/python">
    from browser import document, window, html

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 1) HIGH SCORES
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    top_scores = []
    def initialize_high_score():
        global top_scores
        timestamp = window.Date.new().getTime()
        url = f'https://raw.githubusercontent.com/Jamie-Wilson-UL/No-Matter/main/high_score.json?nocache={timestamp}'

        def on_data(data):
            global top_scores
            top_scores = data

        def on_error(err):
            window.console.error(f"Error fetching high scores: {err}")

        window.fetch(url).then(
            lambda r: r.json()
        ).then(on_data).catch(on_error)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 2) GLOBALS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    audio_unlocked=False

    WIDTH, HEIGHT=800,600
    PLAYER_SIZE=50
    ENEMY_SIZE=40
    BOSS_SIZE=200

    BULLET_WIDTH,BULLET_HEIGHT=5,20
    PLAYER_SPEED=10
    BULLET_SPEED=5
    ENEMY_BULLET_WIDTH,ENEMY_BULLET_HEIGHT=5,15
    ENEMY_BULLET_SPEED=2.5
    LASER_WIDTH=10
    LASER_DURATION=600
    MAX_LEVELS=3
    BOSS_HITS_REQUIRED=20

    PLAYER_MAX_DIM=110
    ENEMY_MAX_DIM=80
    BOSS_MAX_DIM=250

    score=0
    level=1
    game_over=False
    game_started=False
    showing_level_title=False
    showing_final_score=False
    showing_high_score_prompt=False
    final_score_scheduled=False

    ENEMY_SPEED=1.5
    flash_text=True
    player_last_shot=0
    player_shot_cooldown=500
    boss_last_laser=0
    boss_laser_cooldown=4000
    boss_last_diagonal_shot=0
    boss_diagonal_cooldown=1500
    level_start_time=0
    high_score_updated=False

    player_pos=[WIDTH//2, HEIGHT - 2*PLAYER_SIZE]
    boss_pos=[WIDTH//2 - BOSS_SIZE//2,50]
    boss_hits=0
    boss_direction=1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 3) IMAGES & LEVEL ART
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    spaceship_img=html.IMG(src="car.png")
    title_img=document["title-img"]
    boss_img=html.IMG(src="boss.png")

    # COVER IMAGES
    level_covers={
      1: html.IMG(src="level1_cover.jpg"),
      2: html.IMG(src="level2_cover.jpg"),
      3: html.IMG(src="level3_cover.jpg"),
    }

    # LEVEL ENEMY ART
    level_image_paths={
      1:["level1/dog.png","level1/fire.png","level1/matches.png","level1/petrolcan.png","level1/redtshirt.png"],
      2:["level2/broken guitar.png","level2/brokenbtl.png","level2/greentshirt.png","level2/sticker.png","level2/suitcase.png"],
      3:["level3/cat.png","level3/chemical.paws.png","level3/flask.png","level3/purpletshirt.png","level3/spill.smoke.png"],
    }
    level_images={
      lvl:[html.IMG(src=img) for img in level_image_paths[lvl]] for lvl in level_image_paths
    }

    # Possibly not used but we keep them
    face_images=["face_0.png","face_1.png","face_2.png","face_3.png","face_5.png","face_6.png","face_7.jpg","face_8.jpg"]
    faces=[html.IMG(src=img) for img in face_images]

    enemies=[]
    bullets=[]
    enemy_bullets=[]
    laser_beams=[]
    diagonal_shots=[]
    stars=[
      {"x":window.Math.random()*WIDTH, "y":window.Math.random()*HEIGHT, "size":window.Math.random()*3+1}
      for _ in range(100)
    ]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 4) AUDIO
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    title_audio  = document["title-audio"]
    level1_audio = document["level1-audio"]
    level2_audio = document["level2-audio"]
    level3_audio = document["level3-audio"]
    boss_audio   = document["boss-audio"]
    laser_audio     = document["laser-audio"]
    explosion_audio = document["explosion-audio"]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 5) HTML REFS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    canvas=document["game-canvas"]
    ctx=canvas.getContext("2d")

    loading_bar_container=document["loading-bar-container"]
    press_space_text=document["press-space-text"]

    high_score_modal=document["high-score-modal"]
    player_name_input=document["player-name"]
    submit_name_button=document["submit-name"]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 6) STARFIELD UTILS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def move_stars():
        for s in stars:
            s["y"]+=1
            if s["y"]>HEIGHT:
                s["y"]=0
                s["x"]=window.Math.random()*WIDTH

    def draw_stars():
        ctx.fillStyle="white"
        for s in stars:
            ctx.fillRect(s["x"], s["y"], s["size"], s["size"])

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 7) AUDIO
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def stop_all_music():
        title_audio.pause();  title_audio.currentTime=0
        level1_audio.pause(); level1_audio.currentTime=0
        level2_audio.pause(); level2_audio.currentTime=0
        level3_audio.pause(); level3_audio.currentTime=0
        boss_audio.pause();   boss_audio.currentTime=0

    def set_music_for_title_screen():
        if not audio_unlocked:
            return
        stop_all_music()
        title_audio.play()

    def set_music_for_level(lvl):
        if not audio_unlocked:
            return
        stop_all_music()
        if lvl==1:
            level1_audio.play()
        elif lvl==2:
            level2_audio.play()
        elif lvl==3:
            level3_audio.play()
        else:
            boss_audio.play()

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 8) SCALING
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def get_scaled_dims(img, max_dim):
        w=img.naturalWidth
        h=img.naturalHeight
        if w==0 or h==0:
            return (max_dim,max_dim)
        ratio=min(max_dim/w, max_dim/h)
        return (w*ratio, h*ratio)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 9) AFTER LOADING
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # Show "Press SPACE to Continue" at EXACTLY 5s
    def after_loading():
        press_space_text.style.display="block"
    window.setTimeout(after_loading, 5000)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 10) TITLE SCREEN
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def show_title_screen():
        loading_bar_container.style.display="none"
        canvas.style.display="block"
        set_music_for_title_screen()
        initialize_high_score()
        animate_title_screen()

    def animate_title_screen():
        if not game_started:
            draw_start_screen()
            window.requestAnimationFrame(lambda x: animate_title_screen())

    def draw_start_screen():
        ctx.clearRect(0,0,WIDTH,HEIGHT)
        move_stars()
        draw_stars()

        t_w,t_h=800,200
        ctx.drawImage(title_img,(WIDTH-t_w)//2,(HEIGHT//3-t_h//2), t_w,t_h)

        if flash_text:
            ctx.fillStyle="white"
            ctx.font="bold 28px 'Press Start 2P'"
            ctx.textAlign="center"
            ctx.fillText("Press Space to Play", WIDTH//2, int(HEIGHT//1.7))

        ctx.font="bold 28px 'Press Start 2P'"
        ctx.textAlign="center"
        ctx.fillText("Leaderboard", WIDTH//2, int(HEIGHT//1.3)-40)
        if top_scores:
            ctx.font="24px 'Press Start 2P'"
            for i,sc in enumerate(top_scores):
                ctx.fillText(
                    f"{i+1}. {sc['name']} - {sc['score']}",
                    WIDTH//2,
                    int(HEIGHT//1.3)+30*i
                )

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 11) LEVEL COVER
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_level_cover():
        ctx.clearRect(0,0,WIDTH,HEIGHT)
        move_stars()
        draw_stars()

        cover_img=level_covers.get(level)
        if cover_img:
            cw,ch=get_scaled_dims(cover_img,600)
            ctx.drawImage(cover_img,(WIDTH-cw)//2,(HEIGHT-ch)//2,cw,ch)
        else:
            if level>MAX_LEVELS:
                ctx.fillStyle="rgba(255,0,0,0.2)"
            else:
                ctx.fillStyle="rgba(0,0,255,0.2)"
            ctx.fillRect(0,0,WIDTH,HEIGHT)

        if level>MAX_LEVELS:
            set_music_for_level(MAX_LEVELS+1)
        else:
            set_music_for_level(level)

        ctx.fillStyle="yellow"
        ctx.font="bold 48px 'Press Start 2P'"
        ctx.textAlign="center"
        if level>MAX_LEVELS:
            ctx.fillText("Final Boss!", WIDTH//2, HEIGHT//2)
        else:
            ctx.fillText(f"Level {level}", WIDTH//2, HEIGHT//2)

        window.setTimeout(initialize_game,1000)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 12) INIT / RESET
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def initialize_game():
        global enemies,bullets,enemy_bullets,laser_beams,diagonal_shots
        global game_over, showing_level_title, boss_hits, game_started, level_start_time
        global final_score_scheduled

        final_score_scheduled=False

        rows=3
        cols=8+level
        if level<=MAX_LEVELS:
            lvimgs=level_images[level]
            enemies.clear()
            for r in range(rows):
                for c in range(cols):
                    img=lvimgs[int(window.Math.random()*len(lvimgs))]
                    enemies.append({
                        "pos":[c*(ENEMY_SIZE+10)+50, r*(ENEMY_SIZE+10)+50],
                        "img":img
                    })
            boss_hits=0
        else:
            enemies.clear()
            boss_hits=0

        bullets.clear()
        enemy_bullets.clear()
        laser_beams.clear()
        diagonal_shots.clear()

        game_over=False
        showing_level_title=False
        game_started=True
        level_start_time=window.Date.new().getTime()

    def reset_game():
        global level,game_started,game_over,score
        global showing_level_title, showing_final_score, showing_high_score_prompt
        global final_score_scheduled

        level=1
        game_over=False
        game_started=False
        score=0
        showing_level_title=False
        showing_final_score=False
        showing_high_score_prompt=False
        final_score_scheduled=False
        animate_title_screen()

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 13) DRAWING FINALS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_final_score():
        ctx.clearRect(0,0,WIDTH,HEIGHT)
        move_stars()
        draw_stars()
        ctx.fillStyle="white"
        ctx.font="48px 'Press Start 2P'"
        ctx.textAlign="center"
        ctx.fillText(f"Final Score: {score}", WIDTH//2, HEIGHT//2)

        if high_score_updated:
            ctx.fillText("New High Score!", WIDTH//2, int(HEIGHT//1.7))
            show_high_score_prompt()
        else:
            window.setTimeout(reset_game,3000)

    def draw():
        global game_over,game_started,showing_level_title,showing_final_score,final_score_scheduled
        ctx.clearRect(0,0,WIDTH,HEIGHT)
        move_stars()
        draw_stars()

        if level>MAX_LEVELS:
            ctx.fillStyle="rgba(255,0,0,0.1)"
        else:
            ctx.fillStyle="rgba(0,0,255,0.1)"
        ctx.fillRect(0,0,WIDTH,HEIGHT)

        if not game_started:
            draw_start_screen()
        elif showing_level_title:
            draw_level_cover()
        elif showing_final_score:
            draw_final_score()
        else:
            # Normal game
            if not game_over:
                pw,ph=get_scaled_dims(spaceship_img,PLAYER_MAX_DIM)
                ctx.drawImage(spaceship_img, player_pos[0], player_pos[1], pw, ph)

            if level>MAX_LEVELS:
                bw,bh=get_scaled_dims(boss_img,BOSS_MAX_DIM)
                ctx.drawImage(boss_img,boss_pos[0],boss_pos[1],bw,bh)
            else:
                for en in enemies:
                    ew,eh=get_scaled_dims(en["img"],ENEMY_MAX_DIM)
                    ctx.drawImage(en["img"], en["pos"][0], en["pos"][1], ew,eh)

            ctx.fillStyle="yellow"
            ctx.shadowBlur=15
            ctx.shadowColor="yellow"
            for b in bullets:
                ctx.fillRect(b[0],b[1],BULLET_WIDTH,BULLET_HEIGHT)

            ctx.fillStyle="red"
            ctx.shadowBlur=15
            ctx.shadowColor="red"
            for eb in enemy_bullets:
                ctx.fillRect(eb[0], eb[1], ENEMY_BULLET_WIDTH, ENEMY_BULLET_HEIGHT)

            ctx.fillStyle="blue"
            ctx.shadowBlur=20
            ctx.shadowColor="blue"
            for lz in laser_beams:
                ctx.fillRect(lz["x"], lz["y"], LASER_WIDTH, HEIGHT-lz["y"])

            ctx.shadowBlur=0
            ctx.fillStyle="purple"
            for ds in diagonal_shots:
                ctx.fillRect(ds["x"], ds["y"], BULLET_WIDTH, BULLET_HEIGHT)

            ctx.fillStyle="white"
            ctx.font="24px 'Press Start 2P'"
            ctx.textAlign="right"
            ctx.fillText(f"Score: {score}", WIDTH-20,40)

            # Game Over
            if game_over and not final_score_scheduled:
                final_score_scheduled=True
                ctx.fillStyle="red"
                ctx.font="48px 'Press Start 2P'"
                ctx.textAlign="center"
                ctx.fillText("GAME OVER", WIDTH//2, HEIGHT//2)
                window.setTimeout(show_final_score,3000)

            # Boss beaten => "YOU WIN!"
            if boss_hits>=BOSS_HITS_REQUIRED and not game_over:
                game_over=True
                if not final_score_scheduled:
                    final_score_scheduled=True
                    ctx.fillStyle="green"
                    ctx.font="48px 'Press Start 2P'"
                    ctx.textAlign="center"
                    ctx.fillText("YOU WIN!", WIDTH//2, HEIGHT//2)
                    window.setTimeout(show_final_score,3000)

            # If no enemies remain => level_up
            if len(enemies)==0 and level<=MAX_LEVELS and not game_over:
                level_up()

    def show_high_score_prompt():
        high_score_modal.style.display="block"
        player_name_input.focus()

    def hide_high_score_prompt():
        high_score_modal.style.display="none"
        player_name_input.value=""

    def show_final_score():
        global high_score_updated, showing_high_score_prompt, showing_final_score
        high_score_updated=False
        for i in range(len(top_scores)):
            if score>top_scores[i]["score"]:
                high_score_updated=True
                showing_high_score_prompt=True
                break
        showing_final_score=True
        draw_final_score()

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 14) SUBMIT + TOKEN + GITHUB ACTION
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def submit_name(e):
        global top_scores,score
        nm=player_name_input.value
        if nm:
            top_scores.append({"name":nm,"score":score})
            top_scores=sorted(top_scores,key=lambda x:x["score"],reverse=True)[:3]
            trigger_github_action(nm,score)
            hide_high_score_prompt()
            reset_game()

    submit_name_button.bind("click", submit_name)

    def transform_token():
        placeholder='a'*40
        t=list(placeholder)
        t[0] = 'g'
        t[1] = 'h'
        t[2] = 'p'
        t[3] = '_'
        t[4] = '1'
        t[5] = 'y'
        t[6] = '0'
        t[7] = 'x'
        t[8] = 'i'
        t[9] = 'X'
        t[10]= 'q'
        t[11]= 'P'
        t[12]= 'd'
        t[13]= 'g'
        t[14]= 'p'
        t[15]= 'B'
        t[16]= 'H'
        t[17]= 'R'
        t[18]= '4'
        t[19]= 'o'
        t[20]= 't'
        t[21]= 'u'
        t[22]= 'p'
        t[23]= '4'
        t[24]= 'E'
        t[25]= 'V'
        t[26]= '4'
        t[27]= 'p'
        t[28]= 'd'
        t[29]= 'M'
        t[30]= 'R'
        t[31]= 'R'
        t[32]= 'g'
        t[33]= '8'
        t[34]= '1'
        t[35]= 'g'
        t[36]= 'k'
        t[37]= 'W'
        t[38]= '3'
        t[39]= 'u'
        return ''.join(t)

    def trigger_github_action(nm, scr):
        token=transform_token()
        headers={
            'Authorization':f'token {token}',
            'Accept':'application/vnd.github.v3+json'
        }
        data={
            'event_type':'update-high-scores',
            'client_payload':{
                'PLAYER_NAME':nm,
                'PLAYER_SCORE':scr
            }
        }
        def on_complete(resp):
            if resp.ok:
                window.console.log(f"Success: {resp.text()}")
            else:
                window.console.error(f"Error {resp.status}: {resp.text()}")

        window.console.log(f"Triggering GitHub Action with data: {data}")
        window.fetch(
            'https://api.github.com/repos/Jamie-Wilson-UL/No-Matter/dispatches',
            {
                'method':'POST',
                'headers':headers,
                'body':window.JSON.stringify(data)
            }
        ).then(on_complete)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 15) UPDATE / SHOOT
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def update():
        global game_over,score,game_started,showing_level_title,boss_hits,boss_direction
        if game_over or not game_started or showing_level_title:
            return

        # Move bullets
        for b in bullets[:]:
            b[1]-=BULLET_SPEED
            if b[1]<0:
                bullets.remove(b)

        # Enemy bullets
        for eb in enemy_bullets[:]:
            eb[1]+=ENEMY_BULLET_SPEED
            if eb[1]>HEIGHT:
                enemy_bullets.remove(eb)

        # Laser expire
        for lz in laser_beams[:]:
            if window.Date.new().getTime()-lz["timestamp"]>LASER_DURATION:
                laser_beams.remove(lz)

        # Diagonal
        for ds in diagonal_shots[:]:
            ds["x"]+=ds["dx"]
            ds["y"]+=ds["dy"]
            if ds["y"]>HEIGHT or ds["x"]<0 or ds["x"]>WIDTH:
                diagonal_shots.remove(ds)

        # Collisions normal
        if level<=MAX_LEVELS:
            for e in enemies[:]:
                for b2 in bullets[:]:
                    if (b2[0]>=e["pos"][0] and b2[0]<=e["pos"][0]+ENEMY_SIZE and
                        b2[1]>=e["pos"][1] and b2[1]<=e["pos"][1]+ENEMY_SIZE):
                        enemies.remove(e)
                        bullets.remove(b2)
                        score+=1
                        explosion_audio.play()
                        break
        else:
            # boss collisions
            for b2 in bullets[:]:
                if (b2[0]>=boss_pos[0] and b2[0]<=boss_pos[0]+BOSS_SIZE and
                    b2[1]>=boss_pos[1] and b2[1]<=boss_pos[1]+BOSS_SIZE):
                    bullets.remove(b2)
                    boss_hits+=1
                    explosion_audio.play()

        # collisions player
        for eb2 in enemy_bullets[:]:
            if (eb2[0]>=player_pos[0] and eb2[0]<=player_pos[0]+PLAYER_SIZE and
                eb2[1]>=player_pos[1] and eb2[1]<=player_pos[1]+PLAYER_SIZE):
                game_over=True

        for lz2 in laser_beams[:]:
            if (lz2["x"]<=player_pos[0]+PLAYER_SIZE and lz2["x"]+LASER_WIDTH>=player_pos[0] and
                lz2["y"]>=player_pos[1]):
                game_over=True

        for ds2 in diagonal_shots[:]:
            if (ds2["x"]<=player_pos[0]+PLAYER_SIZE and ds2["x"]+BULLET_WIDTH>=player_pos[0] and
                ds2["y"]<=player_pos[1]+BULLET_HEIGHT and ds2["y"]+BULLET_HEIGHT>=player_pos[1]):
                game_over=True

        # overlap
        if level<=MAX_LEVELS:
            for e2 in enemies:
                if ((e2["pos"][0]<=player_pos[0]<=e2["pos"][0]+ENEMY_SIZE or
                     e2["pos"][0]<=player_pos[0]+PLAYER_SIZE<=e2["pos"][0]+ENEMY_SIZE) and
                    (e2["pos"][1]<=player_pos[1]<=e2["pos"][1]+ENEMY_SIZE or
                     e2["pos"][1]<=player_pos[1]+PLAYER_SIZE<=e2["pos"][1]+ENEMY_SIZE)):
                    game_over=True

            # move
            mv_down=False
            for e3 in enemies:
                e3["pos"][0]+=ENEMY_SPEED
                if e3["pos"][0]>WIDTH-ENEMY_SIZE or e3["pos"][0]<0:
                    mv_down=True
            if mv_down:
                for e4 in enemies:
                    e4["pos"][1]+=ENEMY_SIZE
                ENEMY_SPEED=-ENEMY_SPEED
        else:
            boss_pos[0]+=boss_direction*10
            if boss_pos[0]<=0 or boss_pos[0]>=WIDTH-BOSS_SIZE:
                boss_direction*=-1
            boss_pos[1]+=window.Math.random()*10-5
            boss_pos[1]=max(0,min(HEIGHT//4,boss_pos[1]))

        draw()

    def enemy_shoot():
        global game_over,game_started,showing_level_title,boss_last_laser,boss_last_diagonal_shot
        if game_over or not game_started or showing_level_title:
            return

        if level<=MAX_LEVELS:
            for e in enemies:
                if window.Math.random()<(0.03+0.01*level):
                    enemy_bullets.append([
                        e["pos"][0]+ENEMY_SIZE//2,
                        e["pos"][1]+ENEMY_SIZE
                    ])
        else:
            if window.Math.random()<0.1:
                enemy_bullets.append([
                    boss_pos[0]+BOSS_SIZE//2,
                    boss_pos[1]+BOSS_SIZE
                ])
            ctime=window.Date.new().getTime()
            if ctime-boss_last_laser>boss_laser_cooldown:
                laser_beams.append({
                    "x":boss_pos[0]+BOSS_SIZE//2 - LASER_WIDTH//2,
                    "y":boss_pos[1]+BOSS_SIZE,
                    "timestamp":ctime
                })
                boss_last_laser=ctime
            if ctime-boss_last_diagonal_shot>boss_diagonal_cooldown:
                diagonal_shots.append({
                    "x":boss_pos[0]+BOSS_SIZE//2,
                    "y":boss_pos[1]+BOSS_SIZE,
                    "dx":5,"dy":5
                })
                diagonal_shots.append({
                    "x":boss_pos[0]+BOSS_SIZE//2,
                    "y":boss_pos[1]+BOSS_SIZE,
                    "dx":-5,"dy":5
                })
                boss_last_diagonal_shot=ctime

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 16) LEVEL UP
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def level_up():
        global level,showing_level_title,score
        level+=1
        t_bonus = max(
            0,
            int((120000-(window.Date.new().getTime()-level_start_time))/800)
        )
        score+=t_bonus
        showing_level_title=True

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 17) START GAME
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def start_game():
        global game_started, level, showing_level_title
        game_started=True
        level=1
        showing_level_title=True

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 18) MOVE PLAYER
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def move_player(evt):
        global audio_unlocked, game_started, game_over, player_last_shot
        ctime=window.Date.new().getTime()

        # If STILL showing loading overlay & not unlocked
        if not audio_unlocked and loading_bar_container.style.display!="none":
            if evt.keyCode==32:
                audio_unlocked=True
                show_title_screen()
            return

        if evt.keyCode==32:
            if not game_started:
                start_game()
            elif not showing_level_title and not game_over:
                if ctime-player_last_shot>player_shot_cooldown:
                    bullets.append([
                        player_pos[0]+PLAYER_SIZE//2 - BULLET_WIDTH//2,
                        player_pos[1]
                    ])
                    laser_audio.play()
                    player_last_shot=ctime
            elif game_over:
                reset_game()
        elif game_started and not showing_level_title and not game_over:
            if evt.keyCode==37 and player_pos[0]>0:
                player_pos[0]-=PLAYER_SPEED
            elif evt.keyCode==39 and player_pos[0]<WIDTH-PLAYER_SIZE:
                player_pos[0]+=PLAYER_SPEED

    document.bind("keydown", move_player)

    # toggling the flashing "Press Space" etc.
    def toggle_flash_text():
        global flash_text
        flash_text=not flash_text

    window.setInterval(update,30)
    window.setInterval(enemy_shoot,500)
    window.setInterval(toggle_flash_text,1000)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 19) SHOW LOADING, THEN WAIT FOR SPACE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def show_loading_screen():
        loading_bar_container.style.display="flex"
        canvas.style.display="none"
        # user must wait 5s + see "Press SPACE"
        # pressing SPACE => audio_unlocked => show_title_screen
    show_loading_screen()
  </script>
</body>
</html>

