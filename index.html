<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>No Matter Blaster</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
  <style>
    body {
      text-align: center;
      background-color: black;
      color: white;
      font-family: 'Press Start 2P', monospace;
      overflow: hidden;
    }
    canvas {
      border: 8px solid #00ff00;
      border-radius: 10px;
      box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00, 0 0 60px #00ff00, 0 0 80px #00ff00;
      display: block;
      margin: 20px auto;
      background-color: #000;
    }
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    @keyframes breathing {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes fill {
      0%   { width: 0; }
      100% { width: 100%; }
    }
    #title-img {
      animation: breathing 3s infinite;
    }
    /* LOADING OVERLAY */
    #loading-bar-container {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: black;
    }
    #loading-bar {
      width: 50%;
      height: 30px;
      background-color: white;
      border: 3px solid #00ff00;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #loading-progress {
      height: 100%;
      width: 0;
      background-color: #00ff00;
      animation: fill 3s linear forwards; /* 3s fill */
    }
    #loading-text {
      font-size: 24px;
      font-family: 'Press Start 2P', monospace;
      color: white;
      font-weight: bold;
      margin-bottom: 20px;
    }
    #press-space-loading {
      display: none; /* shown after bar finishes */
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      color: white;
      margin-top: 20px;
    }
    #high-score-modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      color: white;
      font-family: 'Press Start 2P', monospace;
    }
    #high-score-modal-content {
      background-color: black;
      margin: 15% auto;
      padding: 20px;
      border: 3px solid #00ff00;
      width: 80%; max-width: 400px;
      text-align: center;
    }
    #player-name {
      width: 80%;
      height: 40px;
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      margin-bottom: 10px;
    }
    #submit-name {
      width: 80%;
      height: 40px;
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      background-color: #00ff00;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body onload="brython()">

  <!-- LOADING OVERLAY -->
  <div id="loading-bar-container">
    <div id="loading-text">Loading...</div>
    <div id="loading-bar">
      <div id="loading-progress"></div>
    </div>
    <!-- Press SPACE after bar finishes -->
    <p id="press-space-loading">Press SPACE to Continue</p>
  </div>

  <!-- GAME CANVAS -->
  <canvas id="game-canvas" width="800" height="600" style="display:none;"></canvas>

  <!-- TITLE IMAGE -->
  <img id="title-img" src="title.gif" style="display:none"/>

  <!-- HIGH SCORE MODAL -->
  <div id="high-score-modal">
    <div id="high-score-modal-content">
      <p>New High Score! Enter your name:</p>
      <input type="text" id="player-name"/>
      <button id="submit-name">Submit</button>
    </div>
  </div>

  <script type="text/python">
    from browser import document, html, window

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 1) GAME CONSTANTS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    WIDTH, HEIGHT = 800, 600
    PLAYER_SIZE = 50
    ENEMY_SIZE = 40
    BOSS_SIZE = 200

    BULLET_WIDTH, BULLET_HEIGHT = 5, 20
    PLAYER_SPEED = 10
    BULLET_SPEED = 5
    ENEMY_BULLET_WIDTH, ENEMY_BULLET_HEIGHT = 5, 15
    ENEMY_BULLET_SPEED = 2.5
    LASER_WIDTH = 10
    LASER_DURATION = 600
    MAX_LEVELS = 3
    BOSS_HITS_REQUIRED = 20

    PLAYER_MAX_DIM = 110
    ENEMY_MAX_DIM = 80
    BOSS_MAX_DIM = 250

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 2) GLOBAL STATE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    score = 0
    level = 1
    game_over = False
    game_started = False
    showing_level_title = False
    showing_final_score = False
    showing_high_score_prompt = False
    final_score_scheduled = False

    ENEMY_SPEED = 1.5
    flash_text = True
    player_last_shot = 0
    player_shot_cooldown = 500
    boss_last_laser = 0
    boss_laser_cooldown = 4000
    boss_last_diagonal_shot = 0
    boss_diagonal_cooldown = 1500
    level_start_time = 0
    top_scores = []
    high_score_updated = False

    player_pos = [WIDTH // 2, HEIGHT - 2 * PLAYER_SIZE]
    boss_pos = [WIDTH // 2 - BOSS_SIZE // 2, 50]
    boss_hits = 0
    boss_direction = 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 3) IMAGES (Enemies as Images)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    spaceship_img = html.IMG(src="car.png")
    title_img = document["title-img"]
    boss_img = html.IMG(src="boss.png")

    level_image_paths = {
        1: ["level1/dog.png","level1/fire.png","level1/matches.png","level1/petrolcan.png","level1/redtshirt.png"],
        2: ["level2/broken_guitar.png","level2/brokenbtl.png","level2/greentshirt.png","level2/sticker.png","level2/suitcase.png"],
        3: ["level3/cat.png","level3/chemical_paws.png","level3/flask.png","level3/purpletshirt.png","level3/spill_smoke.png"],
    }
    level_images = {
        lvl: [html.IMG(src=path) for path in level_image_paths[lvl]] 
        for lvl in level_image_paths
    }

    enemies = []  # List of dictionaries with 'pos' and 'img'
    bullets = []
    enemy_bullets = []
    laser_beams = []
    diagonal_shots = []
    stars = [{"x":window.Math.random()*WIDTH, "y":window.Math.random()*HEIGHT, "size":window.Math.random()*3+1} for _ in range(100)]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 4) REFERENCES
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    canvas = document["game-canvas"]
    ctx = canvas.getContext("2d")
    loading_bar_container = document["loading-bar-container"]
    press_space_loading = document["press-space-loading"]

    high_score_modal = document["high-score-modal"]
    player_name_input = document["player-name"]
    submit_name_button = document["submit-name"]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 5) SCALING
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def get_scaled_dims(img, max_dim):
        w = img.naturalWidth
        h = img.naturalHeight
        if w == 0 or h == 0:
            return (max_dim, max_dim)
        ratio = min(max_dim / w, max_dim / h)
        return (w * ratio, h * ratio)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 6) INIT / RESET
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def initialize_game():
        global enemies, bullets, enemy_bullets, laser_beams, diagonal_shots
        global showing_level_title, ENEMY_SPEED, game_over, level
        global game_started, score, boss_hits, level_start_time, final_score_scheduled

        final_score_scheduled = False

        rows = 3
        cols = 8 + level
        if level <= MAX_LEVELS:
            curimgs = level_images[level]
            enemies.clear()
            for r in range(rows):
                for c in range(cols):
                    img = curimgs[int(window.Math.random() * len(curimgs))]
                    enemies.append({
                        "pos": [c * (ENEMY_SIZE + 10) + 50, r * (ENEMY_SIZE + 10) + 50],
                        "img": img
                    })
            boss_hits = 0
        else:
            enemies.clear()
            boss_hits = 0

        bullets.clear()
        enemy_bullets.clear()
        laser_beams.clear()
        diagonal_shots.clear()

        showing_level_title = False
        ENEMY_SPEED = 1.5 + level
        game_over = False
        game_started = True
        level_start_time = window.Date.new().getTime()

        window.console.log(f"Initialized Level {level} with {len(enemies)} enemies.")

    def reset_game():
        global level, game_started, game_over, score
        global showing_level_title, showing_final_score, showing_high_score_prompt
        global final_score_scheduled

        level = 1
        game_over = False
        game_started = False
        score = 0
        showing_level_title = False
        showing_final_score = False
        showing_high_score_prompt = False
        final_score_scheduled = False

        window.console.log("Game reset.")
        animate_title_screen()

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 7) LOADING SCREEN
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def show_loading_screen():
        loading_bar_container.style.display = "flex"
        canvas.style.display = "none"

        def reveal_press_space():
            press_space_loading.style.display = "block"  # show text after bar finishes
            window.console.log("Loading complete. Prompting to press SPACE.")

        window.setTimeout(reveal_press_space, 3000)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 8) TITLE SCREEN
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def show_title_screen():
        loading_bar_container.style.display = "none"
        canvas.style.display = "block"
        initialize_high_score()
        animate_title_screen()

    def animate_title_screen():
        if not game_started:
            draw_start_screen()
            window.requestAnimationFrame(lambda x: animate_title_screen())

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 9) DRAW START SCREEN
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_start_screen():
        ctx.clearRect(0, 0, WIDTH, HEIGHT)
        move_stars()
        draw_stars()

        t_w, t_h = 800, 200
        ctx.drawImage(title_img, (WIDTH - t_w) // 2, (HEIGHT // 3 - t_h // 2), t_w, t_h)

        if flash_text:
            ctx.fillStyle = "white"
            ctx.font = "bold 28px 'Press Start 2P'"
            ctx.textAlign = "center"
            ctx.fillText("Press Space to Play", WIDTH // 2, int(HEIGHT / 1.7))
            window.console.log("Displayed 'Press Space to Play' prompt.")

        ctx.font = "bold 28px 'Press Start 2P'"
        ctx.textAlign = "center"
        ctx.fillText("Leaderboard", WIDTH // 2, int(HEIGHT / 1.3) - 40)

        if top_scores:
            ctx.font = "24px 'Press Start 2P'"
            for i, sc_data in enumerate(top_scores):
                ctx.fillText(
                    f"{i+1}. {sc_data['name']} - {sc_data['score']}",
                    WIDTH // 2,
                    int(HEIGHT / 1.3) + 30 * i
                )
            window.console.log("Displayed leaderboard.")

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 10) DRAW LEVEL TITLE (No Images)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_level_title():
        ctx.clearRect(0, 0, WIDTH, HEIGHT)
        move_stars()
        draw_stars()

        ctx.fillStyle = "yellow"
        ctx.font = "bold 48px 'Press Start 2P'"
        ctx.textAlign = "center"

        if level > MAX_LEVELS:
            ctx.fillText("Final Boss!", WIDTH // 2, HEIGHT // 2)
            window.console.log("Displayed 'Final Boss!' title.")
        else:
            ctx.fillText(f"Level {level}", WIDTH // 2, HEIGHT // 2)
            window.console.log(f"Displayed 'Level {level}' title.")

        # Proceed to initialize the game after 1 second
        window.setTimeout(initialize_game, 1000)
        window.console.log(f"Scheduled initialize_game to start Level {level} in 1 second.")

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 11) DRAW FINAL SCORE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_final_score():
        ctx.clearRect(0, 0, WIDTH, HEIGHT)
        move_stars()
        draw_stars()
        ctx.fillStyle = "white"
        ctx.font = "48px 'Press Start 2P'"
        ctx.textAlign = "center"
        ctx.fillText(f"Final Score: {score}", WIDTH // 2, HEIGHT // 2)
        window.console.log(f"Displayed final score: {score}")

        if high_score_updated:
            ctx.fillText("New High Score!", WIDTH // 2, int(HEIGHT / 1.7))
            window.console.log("Displayed 'New High Score!' prompt.")
            show_high_score_prompt()
        else:
            window.setTimeout(reset_game, 3000)
            window.console.log("Scheduled game reset after final score.")

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 12) STARS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def move_stars():
        for s in stars:
            s["y"] += 1
            if s["y"] > HEIGHT:
                s["y"] = 0
                s["x"] = window.Math.random() * WIDTH

    def draw_stars():
        ctx.fillStyle = "white"
        for s in stars:
            ctx.fillRect(s["x"], s["y"], s["size"], s["size"])

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 13) DRAW (MAIN)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw():
        global game_over, game_started, showing_level_title, showing_final_score, final_score_scheduled

        ctx.clearRect(0, 0, WIDTH, HEIGHT)
        move_stars()
        draw_stars()

        # Tint based on level
        if level > MAX_LEVELS:
            ctx.fillStyle = "rgba(255,0,0,0.1)"
        else:
            ctx.fillStyle = "rgba(0,0,255,0.1)"
        ctx.fillRect(0, 0, WIDTH, HEIGHT)

        if not game_started:
            draw_start_screen()
        elif showing_level_title:
            draw_level_title()
        elif showing_final_score:
            draw_final_score()
        else:
            # Normal game rendering
            if not game_over:
                # Draw player as an image
                pw, ph = get_scaled_dims(spaceship_img, PLAYER_MAX_DIM)
                ctx.drawImage(spaceship_img, player_pos[0], player_pos[1], pw, ph)
                window.console.log("Drew player.")

            if level > MAX_LEVELS:
                # Draw boss as an image
                bw, bh = get_scaled_dims(boss_img, BOSS_MAX_DIM)
                ctx.drawImage(boss_img, boss_pos[0], boss_pos[1], bw, bh)
                window.console.log("Drew boss.")
            else:
                # Draw enemies as images
                for e in enemies:
                    ew, eh = get_scaled_dims(e["img"], ENEMY_MAX_DIM)
                    ctx.drawImage(e["img"], e["pos"][0], e["pos"][1], ew, eh)
                window.console.log(f"Drew {len(enemies)} enemies.")

            # Bullets
            ctx.fillStyle = "yellow"
            ctx.shadowBlur = 15
            ctx.shadowColor = "yellow"
            for b in bullets:
                ctx.fillRect(b[0], b[1], BULLET_WIDTH, BULLET_HEIGHT)

            # Enemy Bullets
            ctx.fillStyle = "red"
            ctx.shadowBlur = 15
            ctx.shadowColor = "red"
            for eb in enemy_bullets:
                ctx.fillRect(eb[0], eb[1], ENEMY_BULLET_WIDTH, ENEMY_BULLET_HEIGHT)

            # Laser Beams
            ctx.fillStyle = "blue"
            ctx.shadowBlur = 20
            ctx.shadowColor = "blue"
            for lz in laser_beams:
                ctx.fillRect(lz["x"], lz["y"], LASER_WIDTH, HEIGHT - lz["y"])

            # Diagonal Shots
            ctx.shadowBlur = 0
            ctx.fillStyle = "purple"
            for ds in diagonal_shots:
                ctx.fillRect(ds["x"], ds["y"], BULLET_WIDTH, BULLET_HEIGHT)

            # Score Display
            ctx.fillStyle = "white"
            ctx.font = "24px 'Press Start 2P'"
            ctx.textAlign = "right"
            ctx.fillText(f"Score: {score}", WIDTH - 20, 40)
            window.console.log(f"Updated score display: {score}")

            # GAME OVER
            if game_over and not final_score_scheduled:
                final_score_scheduled = True
                ctx.fillStyle = "red"
                ctx.font = "48px 'Press Start 2P'"
                ctx.textAlign = "center"
                ctx.fillText("GAME OVER", WIDTH // 2, HEIGHT // 2)
                window.console.log("Displayed 'GAME OVER' screen.")
                window.setTimeout(show_final_score, 3000)

            # YOU WIN
            if boss_hits >= BOSS_HITS_REQUIRED and not game_over:
                game_over = True
                if not final_score_scheduled:
                    final_score_scheduled = True
                    ctx.fillStyle = "green"
                    ctx.font = "48px 'Press Start 2P'"
                    ctx.textAlign = "center"
                    ctx.fillText("YOU WIN!", WIDTH // 2, HEIGHT // 2)
                    window.console.log("Displayed 'YOU WIN!' screen.")
                    window.setTimeout(show_final_score, 3000)

            # LEVEL UP
            if len(enemies) == 0 and level <= MAX_LEVELS and not game_over:
                level_up()
                window.console.log(f"Level up to Level {level}.")

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 14) SHOW FINAL SCORE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def show_final_score():
        global high_score_updated, showing_high_score_prompt, showing_final_score
        high_score_updated = False
        for i in range(len(top_scores)):
            if score > top_scores[i]["score"]:
                high_score_updated = True
                showing_high_score_prompt = True
                break
        showing_final_score = True
        draw_final_score()

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 15) HIGH SCORE SUBMIT
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def submit_name(evt):
        global top_scores, score
        nm = player_name_input.value
        if nm:
            top_scores.append({"name": nm, "score": score})
            top_scores = sorted(top_scores, key=lambda x: x["score"], reverse=True)[:3]
            trigger_github_action(nm, score)  # This function can remain if high scores are managed externally
            hide_high_score_prompt()
            reset_game()

    submit_name_button.bind("click", submit_name)

    def transform_token():
        placeholder = 'a' * 40
        t = list(placeholder)
        t[0] = 'g'
        t[1] = 'h'
        t[2] = 'p'
        t[3] = '_'
        t[4] = '1'
        t[5] = 'y'
        t[6] = '0'
        t[7] = 'x'
        t[8] = 'i'
        t[9] = 'X'
        t[10] = 'q'
        t[11] = 'P'
        t[12] = 'd'
        t[13] = 'g'
        t[14] = 'p'
        t[15] = 'B'
        t[16] = 'H'
        t[17] = 'R'
        t[18] = '4'
        t[19] = 'o'
        t[20] = 't'
        t[21] = 'u'
        t[22] = 'p'
        t[23] = '4'
        t[24] = 'E'
        t[25] = 'V'
        t[26] = '4'
        t[27] = 'p'
        t[28] = 'd'
        t[29] = 'M'
        t[30] = 'R'
        t[31] = 'R'
        t[32] = 'g'
        t[33] = '8'
        t[34] = '1'
        t[35] = 'g'
        t[36] = 'k'
        t[37] = 'W'
        t[38] = '3'
        t[39] = 'u'
        return ''.join(t)

    def trigger_github_action(nm, scr):
        token = transform_token()
        headers = {
            'Authorization': f'token {token}',
            'Accept': 'application/vnd.github.v3+json'
        }
        data = {
            'event_type': 'update-high-scores',
            'client_payload': {
                'PLAYER_NAME': nm,
                'PLAYER_SCORE': scr
            }
        }

        def on_complete(resp):
            if resp.ok:
                window.console.log(f"Success: {resp.text()}")
            else:
                window.console.error(f"Error {resp.status}: {resp.text()}")

        window.console.log(f"Triggering GitHub Action with data: {data}")
        window.fetch(
            'https://api.github.com/repos/Jamie-Wilson-UL/No-Matter/dispatches',
            {
                'method': 'POST',
                'headers': headers,
                'body': window.JSON.stringify(data)
            }
        ).then(on_complete)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 16) UPDATE + SHOOT
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def update():
        global game_over, score, game_started, showing_level_title, boss_hits, boss_direction
        if game_over or not game_started or showing_level_title:
            return

        # Move player bullets
        for b in bullets[:]:
            b[1] -= BULLET_SPEED
            if b[1] < 0:
                bullets.remove(b)

        # Move enemy bullets
        for eb in enemy_bullets[:]:
            eb[1] += ENEMY_BULLET_SPEED
            if eb[1] > HEIGHT:
                enemy_bullets.remove(eb)

        # Laser beams expire
        for lz in laser_beams[:]:
            if window.Date.new().getTime() - lz["timestamp"] > LASER_DURATION:
                laser_beams.remove(lz)

        # Diagonal shots
        for ds in diagonal_shots[:]:
            ds["x"] += ds["dx"]
            ds["y"] += ds["dy"]
            if ds["y"] > HEIGHT or ds["x"] < 0 or ds["x"] > WIDTH:
                diagonal_shots.remove(ds)

        # Collisions with normal enemies
        if level <= MAX_LEVELS:
            for en in enemies[:]:
                for b2 in bullets[:]:
                    if (b2[0] >= en["pos"][0] and b2[0] <= en["pos"][0] + ENEMY_SIZE and
                        b2[1] >= en["pos"][1] and b2[1] <= en["pos"][1] + ENEMY_SIZE):
                        enemies.remove(en)
                        bullets.remove(b2)
                        score += 1
                        window.console.log(f"Enemy destroyed. Score: {score}")
                        break
        else:
            # Collisions with boss
            for b2 in bullets[:]:
                if (b2[0] >= boss_pos[0] and b2[0] <= boss_pos[0] + BOSS_SIZE and
                    b2[1] >= boss_pos[1] and b2[1] <= boss_pos[1] + BOSS_SIZE):
                    bullets.remove(b2)
                    boss_hits += 1
                    window.console.log(f"Boss hit. Total hits: {boss_hits}")
                    break

        # Collisions with player
        for eb2 in enemy_bullets[:]:
            if (eb2[0] >= player_pos[0] and eb2[0] <= player_pos[0] + PLAYER_SIZE and
                eb2[1] >= player_pos[1] and eb2[1] <= player_pos[1] + PLAYER_SIZE):
                game_over = True
                window.console.log("Player hit by enemy bullet. Game Over.")

        for lz2 in laser_beams[:]:
            if (lz2["x"] <= player_pos[0] + PLAYER_SIZE and lz2["x"] + LASER_WIDTH >= player_pos[0] and
                lz2["y"] >= player_pos[1]):
                game_over = True
                window.console.log("Player hit by laser beam. Game Over.")

        for ds2 in diagonal_shots[:]:
            if (ds2["x"] <= player_pos[0] + PLAYER_SIZE and ds2["x"] + BULLET_WIDTH >= player_pos[0] and
                ds2["y"] <= player_pos[1] + BULLET_HEIGHT and ds2["y"] + BULLET_HEIGHT >= player_pos[1]):
                game_over = True
                window.console.log("Player hit by diagonal shot. Game Over.")

        # Enemy/player overlap (normal levels)
        if level <= MAX_LEVELS:
            for en2 in enemies:
                if ((en2["pos"][0] <= player_pos[0] <= en2["pos"][0] + ENEMY_SIZE or
                     en2["pos"][0] <= player_pos[0] + PLAYER_SIZE <= en2["pos"][0] + ENEMY_SIZE) and
                    (en2["pos"][1] <= player_pos[1] <= en2["pos"][1] + ENEMY_SIZE or
                     en2["pos"][1] <= player_pos[1] + PLAYER_SIZE <= en2["pos"][1] + ENEMY_SIZE)):
                    game_over = True
                    window.console.log("Player collided with enemy. Game Over.")

            # Enemy movement
            move_down = False
            for e4 in enemies:
                e4["pos"][0] += ENEMY_SPEED
                if e4["pos"][0] > WIDTH - ENEMY_SIZE or e4["pos"][0] < 0:
                    move_down = True
            if move_down:
                for e5 in enemies:
                    e5["pos"][1] += ENEMY_SIZE
                ENEMY_SPEED = -ENEMY_SPEED
                window.console.log(f"Enemies changed direction. New speed: {ENEMY_SPEED}")

        else:
            # Boss movement
            boss_pos[0] += boss_direction * 10
            if boss_pos[0] <= 0 or boss_pos[0] >= WIDTH - BOSS_SIZE:
                boss_direction *= -1
                window.console.log(f"Boss changed direction. New direction: {boss_direction}")
            boss_pos[1] += window.Math.random() * 10 - 5
            boss_pos[1] = max(0, min(HEIGHT // 4, boss_pos[1]))
            window.console.log(f"Boss moved to position: {boss_pos}")

        draw()

    def enemy_shoot():
        global game_over, game_started, showing_level_title, boss_last_laser, boss_last_diagonal_shot
        if game_over or not game_started or showing_level_title:
            return

        if level <= MAX_LEVELS:
            for en in enemies:
                if window.Math.random() < (0.03 + 0.01 * level):
                    enemy_bullets.append([
                        en["pos"][0] + ENEMY_SIZE // 2,
                        en["pos"][1] + ENEMY_SIZE
                    ])
                    window.console.log("Enemy fired a bullet.")
        else:
            if window.Math.random() < 0.1:
                enemy_bullets.append([
                    boss_pos[0] + BOSS_SIZE // 2,
                    boss_pos[1] + BOSS_SIZE
                ])
                window.console.log("Boss fired a bullet.")
            ctime = window.Date.new().getTime()
            if ctime - boss_last_laser > boss_laser_cooldown:
                laser_beams.append({
                    "x": boss_pos[0] + BOSS_SIZE // 2 - LASER_WIDTH // 2,
                    "y": boss_pos[1] + BOSS_SIZE,
                    "timestamp": ctime
                })
                boss_last_laser = ctime
                window.console.log("Boss fired a laser beam.")
            if ctime - boss_last_diagonal_shot > boss_diagonal_cooldown:
                diagonal_shots.append({
                    "x": boss_pos[0] + BOSS_SIZE // 2,
                    "y": boss_pos[1] + BOSS_SIZE,
                    "dx": 5, "dy": 5
                })
                diagonal_shots.append({
                    "x": boss_pos[0] + BOSS_SIZE // 2,
                    "y": boss_pos[1] + BOSS_SIZE,
                    "dx": -5, "dy": 5
                })
                boss_last_diagonal_shot = ctime
                window.console.log("Boss fired diagonal shots.")

    def level_up():
        global level, showing_level_title, score
        level += 1
        time_bonus = max(0, int((120000 - (window.Date.new().getTime() - level_start_time)) / 800))
        score += time_bonus
        showing_level_title = True
        window.console.log(f"Level up to Level {level}. Time bonus: {time_bonus}")
        draw_level_title()

    def start_game():
        global showing_level_title, game_started
        showing_level_title = True  # ensures "Level 1" screen shows
        game_started = True
        window.console.log("Game started. Showing Level Title.")

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 17) MOVE PLAYER
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def move_player(evt):
        global game_started, game_over, player_last_shot
        ctime = window.Date.new().getTime()

        if evt.keyCode == 32:  # SPACE
            window.console.log("SPACE key pressed.")
            if loading_bar_container.style.display != "none":
                # Hide overlay, show canvas
                loading_bar_container.style.display = "none"
                canvas.style.display = "block"
                initialize_high_score()
                animate_title_screen()
                window.console.log("Transitioned from loading screen to title screen.")
                return

            if not game_started:
                start_game()
                window.console.log("Starting the game.")
            elif not showing_level_title and not game_over:
                if ctime - player_last_shot > player_shot_cooldown:
                    bullets.append([
                        player_pos[0] + PLAYER_SIZE // 2 - BULLET_WIDTH // 2,
                        player_pos[1]
                    ])
                    player_last_shot = ctime
                    window.console.log("Player shot a bullet.")
            elif game_over:
                reset_game()
                window.console.log("Resetting the game after game over.")
        elif game_started and not showing_level_title and not game_over:
            if evt.keyCode == 37 and player_pos[0] > 0:
                player_pos[0] -= PLAYER_SPEED
                window.console.log("Player moved left.")
            elif evt.keyCode == 39 and player_pos[0] < WIDTH - PLAYER_SIZE:
                player_pos[0] += PLAYER_SPEED
                window.console.log("Player moved right.")

    def toggle_flash_text():
        global flash_text
        flash_text = not flash_text
        window.console.log(f"Flash text toggled to {flash_text}.")

    def initialize_high_score():
        global top_scores
        timestamp = window.Date.new().getTime()
        url = f'https://raw.githubusercontent.com/Jamie-Wilson-UL/No-Matter/main/high_score.json?nocache={timestamp}'
        window.fetch(url).then(
            lambda r: r.json()
        ).then(
            lambda data: update_high_scores(data)
        ).catch(
            lambda err: window.console.error(f"Error fetching high scores: {err}")
        )
        window.console.log("Fetching high scores.")

    def update_high_scores(data):
        global top_scores
        top_scores = data
        window.console.log(f"High scores updated: {top_scores}")

    document.bind("keydown", move_player)
    window.setInterval(update, 30)
    window.setInterval(enemy_shoot, 500)
    window.setInterval(toggle_flash_text, 1000)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 18) SHOW HIGH SCORE PROMPT
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def show_high_score_prompt():
        high_score_modal.style.display = "block"
        player_name_input.focus()
        window.console.log("Displayed high score prompt.")

    def hide_high_score_prompt():
        high_score_modal.style.display = "none"
        player_name_input.value = ""
        window.console.log("Hidden high score prompt.")

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # 19) START THE GAME
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    show_loading_screen()

  </script>
</body>
</html>
