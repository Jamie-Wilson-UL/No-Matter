<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Matter Blaster</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
    <style>
        body {
            text-align: center;
            background-color: black;
            color: white;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
        }
        canvas {
            border: 8px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00, 0 0 60px #00ff00, 0 0 80px #00ff00;
            display: block;
            margin: 20px auto;
            background-color: #000;
        }
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @keyframes breathing {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        #title-img {
            animation: breathing 3s infinite;
        }
        #loading-bar-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }
        #loading-bar {
            width: 50%;
            height: 30px;
            background-color: white;
            border: 3px solid #00ff00;
            border-radius: 5px;
            overflow: hidden;
        }
        #loading-progress {
            height: 100%;
            width: 0;
            background-color: #00ff00;
        }
        #high-score-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            font-family: 'Press Start 2P', cursive;
        }
        #high-score-modal-content {
            background-color: black;
            margin: 15% auto;
            padding: 20px;
            border: 3px solid #00ff00;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        #player-name {
            width: 80%;
            height: 40px;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
            margin-bottom: 10px;
        }
        #submit-name {
            width: 80%;
            height: 40px;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
            background-color: #00ff00;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body onload="brython()">
    <div id="loading-bar-container">
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
    </div>
    <canvas id="game-canvas" width="800" height="600" style="display:none;"></canvas>
    <audio id="background-audio" src="theme.mp3" loop></audio>
    <audio id="boss-audio" src="boss_theme.mp3" loop></audio>
    <audio id="laser-audio" src="laser.mp3"></audio>
    <audio id="explosion-audio" src="explosion.mp3"></audio>
    <img id="title-img" src="title.gif" style="display:none">
    <div id="high-score-modal">
        <div id="high-score-modal-content">
            <p>New High Score! Enter your name:</p>
            <input type="text" id="player-name">
            <button id="submit-name">Submit</button>
        </div>
    </div>
    <script type="text/python">
        from browser import document, html, window

        WIDTH, HEIGHT = 800, 600
        PLAYER_SIZE = 50
        ENEMY_SIZE = 50
        BOSS_SIZE = 200
        BULLET_WIDTH, BULLET_HEIGHT = 5, 20
        PLAYER_SPEED = 10
        BULLET_SPEED = 5
        ENEMY_BULLET_WIDTH, ENEMY_BULLET_HEIGHT = 5, 15
        ENEMY_BULLET_SPEED = 2.5
        LASER_WIDTH = 10
        LASER_DURATION = 600
        MAX_LEVELS = 3
        BOSS_HITS_REQUIRED = 20

        score = 0
        level = 1
        game_over = False
        game_started = False
        showing_level_title = False
        showing_credits = False
        showing_final_score = False
        showing_high_score_prompt = False
        ENEMY_SPEED = 1.5
        flash_text = True
        player_last_shot = 0
        player_shot_cooldown = 500
        boss_last_laser = 0
        boss_laser_cooldown = 4000
        boss_last_diagonal_shot = 0
        boss_diagonal_cooldown = 1500
        credits_y = HEIGHT
        level_start_time = 0
        top_scores = []
        high_score_updated = False

        player_pos = [WIDTH // 2, HEIGHT - 2 * PLAYER_SIZE]
        boss_pos = [WIDTH // 2 - BOSS_SIZE // 2, 50]
        boss_hits = 0
        boss_direction = 1

        spaceship_img = html.IMG(src="spaceship.png")
        title_img = document["title-img"]
        boss_img = html.IMG(src="boss.png")
        face_images = ["face_0.png", "face_1.png", "face_2.png", "face_3.png"]
        faces = [html.IMG(src=img) for img in face_images]

        enemies = []
        bullets = []
        enemy_bullets = []
        laser_beams = []
        diagonal_shots = []
        stars = [{"x": window.Math.random() * WIDTH, "y": window.Math.random() * HEIGHT, "size": window.Math.random() * 3 + 1} for _ in range(100)]

        canvas = document["game-canvas"]
        ctx = canvas.getContext("2d")
        background_audio = document["background-audio"]
        boss_audio = document["boss-audio"]
        laser_audio = document["laser-audio"]
        explosion_audio = document["explosion-audio"]

        loading_bar_container = document["loading-bar-container"]
        loading_bar = document["loading-bar"]
        loading_progress = document["loading-progress"]

        high_score_modal = document["high-score-modal"]
        player_name_input = document["player-name"]
        submit_name_button = document["submit-name"]

        def initialize_game():
            global enemies, bullets, enemy_bullets, laser_beams, diagonal_shots, showing_level_title, ENEMY_SPEED, game_over, level, game_started, score, boss_hits, level_start_time
            if level <= MAX_LEVELS:
                enemies = [{"pos": [col * (ENEMY_SIZE + 10) + 50, row * (ENEMY_SIZE + 10) + 50], "img": faces[int(window.Math.random() * len(faces))]} for row in range(3) for col in range(8)]
                background_audio.play()
                boss_audio.pause()
            else:
                enemies = []
                boss_hits = 0
                background_audio.pause()
                boss_audio.play()
            bullets = []
            enemy_bullets = []
            laser_beams = []
            diagonal_shots = []
            showing_level_title = False
            ENEMY_SPEED = 1.5 + level
            game_over = False
            game_started = True
            level_start_time = window.Date.new().getTime()

        def reset_game():
            global level, game_started, game_over, score, showing_level_title, showing_credits, showing_high_score_prompt, showing_final_score
            level = 1
            game_over = False
            game_started = False
            score = 0
            showing_level_title = False
            showing_credits = False
            showing_final_score = False
            showing_high_score_prompt = False
            background_audio.play()
            boss_audio.pause()
            animate_title_screen()

        def draw_start_screen():
            ctx.clearRect(0, 0, WIDTH, HEIGHT)
            move_stars()
            draw_stars()
            title_width, title_height = 800, 200
            ctx.drawImage(title_img, (WIDTH - title_width) // 2, (HEIGHT // 3 - title_height // 2), title_width, title_height)
            if flash_text:
                ctx.fillStyle = "white"
                ctx.font = "bold 28px 'Press Start 2P'"
                ctx.textAlign = "center"
                ctx.fillText("Press Space to Play", WIDTH // 2, HEIGHT // 1.7)
            ctx.font = "bold 28px 'Press Start 2P'"
            ctx.fillText("Leaderboard", WIDTH // 2, HEIGHT // 1.3 - 40)
            if top_scores:
                ctx.font = "24px 'Press Start 2P'"
                for i, score in enumerate(top_scores):
                    ctx.fillText(f"{i + 1}. {score['name']} - {score['score']}", WIDTH // 2, HEIGHT // 1.3 + 30 * i)

        def draw_level_title():
            ctx.clearRect(0, 0, WIDTH, HEIGHT)
            move_stars()
            draw_stars()
            ctx.fillStyle = "yellow"
            ctx.font = "bold 48px 'Press Start 2P'"
            if level > MAX_LEVELS:
                ctx.fillText("Final Boss!", WIDTH // 2, HEIGHT // 2)
            else:
                ctx.fillText(f"Level {level}", WIDTH // 2, HEIGHT // 2)

        def draw_final_score():
            ctx.clearRect(0, 0, WIDTH, HEIGHT)
            move_stars()
            draw_stars()
            ctx.fillStyle = "white"
            ctx.font = "48px 'Press Start 2P'"
            ctx.textAlign = "center"
            ctx.fillText(f"Final Score: {score}", WIDTH // 2, HEIGHT // 2)
            if high_score_updated:
                ctx.fillText("New High Score!", WIDTH // 2, HEIGHT // 1.7)
                show_high_score_prompt()

        def show_high_score_prompt():
            high_score_modal.style.display = "block"
            player_name_input.focus()

        def hide_high_score_prompt():
            high_score_modal.style.display = "none"
            player_name_input.value = ""

        def draw_stars():
            ctx.fillStyle = "white"
            for star in stars:
                ctx.fillRect(star["x"], star["y"], star["size"], star["size"])

        def move_stars():
            for star in stars:
                star["y"] += 1
                if star["y"] > HEIGHT:
                    star["y"] = 0
                    star["x"] = window.Math.random() * WIDTH

        def draw():
            global game_over, game_started, showing_level_title, showing_credits, credits_y, showing_high_score_prompt, showing_final_score
            ctx.clearRect(0, 0, WIDTH, HEIGHT)
            move_stars()
            draw_stars()
            if level > MAX_LEVELS:
                ctx.fillStyle = "rgba(255, 0, 0, 0.1)"
                ctx.fillRect(0, 0, WIDTH, HEIGHT)
            else:
                ctx.fillStyle = "rgba(0, 0, 255, 0.1)"
                ctx.fillRect(0, 0, WIDTH, HEIGHT)
            if showing_credits:
                draw_credits()
            elif not game_started:
                draw_start_screen()
            elif showing_level_title:
                draw_level_title()
            elif showing_final_score:
                draw_final_score()
            else:
                if not game_over:
                    ctx.drawImage(spaceship_img, player_pos[0], player_pos[1], PLAYER_SIZE, PLAYER_SIZE)
                if level > MAX_LEVELS:
                    ctx.drawImage(boss_img, boss_pos[0], boss_pos[1], BOSS_SIZE, BOSS_SIZE)
                else:
                    for enemy in enemies:
                        ctx.drawImage(enemy["img"], enemy["pos"][0], enemy["pos"][1], ENEMY_SIZE, ENEMY_SIZE)
                ctx.fillStyle = "yellow"
                ctx.shadowBlur = 15
                ctx.shadowColor = "yellow"
                for bullet in bullets:
                    ctx.fillRect(bullet[0], bullet[1], BULLET_WIDTH, BULLET_HEIGHT)
                ctx.fillStyle = "red"
                ctx.shadowBlur = 15
                ctx.shadowColor = "red"
                for bullet in enemy_bullets:
                    ctx.fillRect(bullet[0], bullet[1], ENEMY_BULLET_WIDTH, ENEMY_BULLET_HEIGHT)
                ctx.fillStyle = "blue"
                ctx.shadowBlur = 20
                ctx.shadowColor = "blue"
                for laser in laser_beams:
                    ctx.fillRect(laser["x"], laser["y"], LASER_WIDTH, HEIGHT - laser["y"])
                ctx.shadowBlur = 0
                ctx.fillStyle = "purple"
                for shot in diagonal_shots:
                    ctx.fillRect(shot["x"], shot["y"], BULLET_WIDTH, BULLET_HEIGHT)
                ctx.fillStyle = "white"
                ctx.font = "24px 'Press Start 2P'"
                ctx.textAlign = "right"
                ctx.fillText(f"Score: {score}", WIDTH - 20, 40)
                if game_over:
                    ctx.fillStyle = "red"
                    ctx.font = "48px 'Press Start 2P'"
                    ctx.fillText("GAME OVER", WIDTH // 2, HEIGHT // 2)
                    window.setTimeout(show_final_score, 3000)
                if len(enemies) == 0 and level <= MAX_LEVELS and not game_over:
                    level_up()
                if boss_hits >= BOSS_HITS_REQUIRED and not game_over:
                    ctx.fillStyle = "green"
                    ctx.font = "48px 'Press Start 2P'"
                    ctx.fillText("YOU WIN!", WIDTH // 2, HEIGHT // 2)
                    game_over = True
                    window.setTimeout(show_final_score, 3000)

        def show_credits():
            global showing_credits, credits_y
            showing_credits = True
            credits_y = HEIGHT
            boss_audio.pause()
            background_audio.play()
            window.setTimeout(animate_credits, 1000)

        def draw_credits():
            global credits_y
            ctx.clearRect(0, 0, WIDTH, HEIGHT)
            ctx.fillStyle = "white"
            ctx.font = "48px 'Press Start 2P'"
            ctx.textAlign = "center"
            ctx.fillText("Credits", WIDTH // 2, credits_y)
            ctx.font = "24px 'Press Start 2P'"
            credits_list = [
                "Jamie Wilson: Development",
                "Caitlin Palmer: Art and Design",
                "Dan Kennedy: Play Tester",
                "Jarlath Cowan: Moral Support"
            ]
            for i, credit in enumerate(credits_list):
                ctx.fillText(credit, WIDTH // 2, credits_y + 50 * (i + 1))
            credits_y -= 1

            if credits_y < -50 * len(credits_list):
                showing_credits = False
                reset_game()

        def animate_credits():
            if showing_credits:
                draw_credits()
                window.requestAnimationFrame(lambda x: animate_credits())

        def show_final_score():
            global high_score_updated, showing_high_score_prompt, showing_final_score
            high_score_updated = False
            # Check if the player achieved a top 3 score
            for i in range(len(top_scores)):
                if score > top_scores[i]["score"]:
                    high_score_updated = True
                    showing_high_score_prompt = True
                    break
            showing_final_score = True
            draw_final_score()
            if high_score_updated:
                showing_high_score_prompt = True
                show_high_score_prompt()
            else:
                if level > MAX_LEVELS:
                    window.setTimeout(show_credits, 3000)
                else:
                    window.setTimeout(reset_game, 3000)

        def update():
            global game_over, score, game_started, showing_level_title, ENEMY_SPEED, boss_hits, boss_direction

            if game_over or not game_started or showing_level_title:
                return

            for bullet in bullets[:]:
                bullet[1] -= BULLET_SPEED
                if bullet[1] < 0:
                    bullets.remove(bullet)

            for bullet in enemy_bullets[:]:
                bullet[1] += ENEMY_BULLET_SPEED
                if bullet[1] > HEIGHT:
                    enemy_bullets.remove(bullet)

            for laser in laser_beams[:]:
                if window.Date.new().getTime() - laser["timestamp"] > LASER_DURATION:
                    laser_beams.remove(laser)

            for shot in diagonal_shots[:]:
                shot["x"] += shot["dx"]
                shot["y"] += shot["dy"]
                if shot["y"] > HEIGHT or shot["x"] < 0 or shot["x"] > WIDTH:
                    diagonal_shots.remove(shot)

            if level <= MAX_LEVELS:
                for enemy in enemies[:]:
                    for bullet in bullets[:]:
                        if bullet[0] >= enemy["pos"][0] and bullet[0] <= enemy["pos"][0] + ENEMY_SIZE and bullet[1] >= enemy["pos"][1] and bullet[1] <= enemy["pos"][1] + ENEMY_SIZE:
                            enemies.remove(enemy)
                            bullets.remove(bullet)
                            score += 1
                            explosion_audio.play()  # Play explosion sound
                            break
            else:
                for bullet in bullets[:]:
                    if bullet[0] >= boss_pos[0] and bullet[0] <= boss_pos[0] + BOSS_SIZE and bullet[1] >= boss_pos[1] and bullet[1] <= boss_pos[1] + BOSS_SIZE:
                        bullets.remove(bullet)
                        boss_hits += 1
                        explosion_audio.play()  # Play explosion sound

            for bullet in enemy_bullets[:]:
                if bullet[0] >= player_pos[0] and bullet[0] <= player_pos[0] + PLAYER_SIZE and bullet[1] >= player_pos[1] and bullet[1] <= player_pos[1] + PLAYER_SIZE:
                    game_over = True

            for laser in laser_beams[:]:
                if laser["x"] <= player_pos[0] + PLAYER_SIZE and laser["x"] + LASER_WIDTH >= player_pos[0] and laser["y"] >= player_pos[1]:
                    game_over = True

            for shot in diagonal_shots[:]:
                if shot["x"] <= player_pos[0] + PLAYER_SIZE and shot["x"] + BULLET_WIDTH >= player_pos[0] and shot["y"] <= player_pos[1] + BULLET_HEIGHT and shot["y"] + BULLET_HEIGHT >= player_pos[1]:
                    game_over = True

            if level <= MAX_LEVELS:
                for enemy in enemies:
                    if (enemy["pos"][0] <= player_pos[0] <= enemy["pos"][0] + ENEMY_SIZE or
                        enemy["pos"][0] <= player_pos[0] + PLAYER_SIZE <= enemy["pos"][0] + ENEMY_SIZE) and \
                        (enemy["pos"][1] <= player_pos[1] <= enemy["pos"][1] + ENEMY_SIZE or
                        enemy["pos"][1] <= player_pos[1] + PLAYER_SIZE <= enemy["pos"][1] + ENEMY_SIZE):
                        game_over = True

                move_down = False
                for enemy in enemies:
                    enemy["pos"][0] += ENEMY_SPEED
                    if enemy["pos"][0] > WIDTH - ENEMY_SIZE or enemy["pos"][0] < 0:
                        move_down = True
                if move_down:
                    for enemy in enemies:
                        enemy["pos"][1] += ENEMY_SIZE
                    ENEMY_SPEED = -ENEMY_SPEED
            else:
                boss_pos[0] += boss_direction * 10
                if boss_pos[0] <= 0 or boss_pos[0] >= WIDTH - BOSS_SIZE:
                    boss_direction *= -1
                boss_pos[1] += window.Math.random() * 10 - 5
                boss_pos[1] = max(0, min(HEIGHT // 4, boss_pos[1]))

            draw()

        def enemy_shoot():
            global game_over, game_started, showing_level_title, boss_last_laser, boss_last_diagonal_shot
            if game_over or not game_started or showing_level_title:
                return
            if level <= MAX_LEVELS:
                for enemy in enemies:
                    if window.Math.random() < (0.03 + 0.01 * level):
                        enemy_bullets.append([enemy["pos"][0] + ENEMY_SIZE // 2, enemy["pos"][1] + ENEMY_SIZE])
            else:
                if window.Math.random() < 0.1:
                    enemy_bullets.append([boss_pos[0] + BOSS_SIZE // 2, boss_pos[1] + BOSS_SIZE])
                current_time = window.Date.new().getTime()
                if current_time - boss_last_laser > boss_laser_cooldown:
                    laser_beams.append({"x": boss_pos[0] + BOSS_SIZE // 2 - LASER_WIDTH // 2, "y": boss_pos[1] + BOSS_SIZE, "timestamp": current_time})
                    boss_last_laser = current_time
                if current_time - boss_last_diagonal_shot > boss_diagonal_cooldown:
                    diagonal_shots.append({"x": boss_pos[0] + BOSS_SIZE // 2, "y": boss_pos[1] + BOSS_SIZE, "dx": 5, "dy": 5})
                    diagonal_shots.append({"x": boss_pos[0] + BOSS_SIZE // 2, "y": boss_pos[1] + BOSS_SIZE, "dx": -5, "dy": 5})
                    boss_last_diagonal_shot = current_time

        def level_up():
            global level, showing_level_title, score
            level += 1
            time_bonus = max(0, int((100000 - (window.Date.new().getTime() - level_start_time)) / 1000))
            score += time_bonus
            showing_level_title = True
            draw_level_title()
            window.setTimeout(initialize_game, 1000)

        def start_game():
            global showing_level_title, game_started
            showing_level_title = False
            game_started = True
            initialize_game()

        def move_player(event):
            global game_started, game_over, player_last_shot
            current_time = window.Date.new().getTime()
            if event.keyCode == 32:
                if not game_started:
                    if background_audio.paused:
                        background_audio.play()
                    start_game()
                elif not showing_level_title and not game_over:
                    if current_time - player_last_shot > player_shot_cooldown:
                        bullets.append([player_pos[0] + PLAYER_SIZE // 2 - BULLET_WIDTH // 2, player_pos[1]])
                        laser_audio.play()  # Play laser sound
                        player_last_shot = current_time
                elif game_over:
                    reset_game()
            elif game_started and not showing_level_title and not game_over:
                if event.keyCode == 37 and player_pos[0] > 0:
                    player_pos[0] -= PLAYER_SPEED
                elif event.keyCode == 39 and player_pos[0] < WIDTH - PLAYER_SIZE:
                    player_pos[0] += PLAYER_SPEED

        def toggle_flash_text():
            global flash_text
            flash_text = not flash_text

        def initialize_high_score():
            global top_scores
            window.fetch('https://raw.githubusercontent.com/Jamie-Wilson-UL/No-Matter/main/high_score.json').then(
                lambda response: response.json()
            ).then(
                lambda data: update_high_scores(data)
            ).catch(
                lambda error: window.console.error(f"Error fetching high scores: {error}")
            )

        def update_high_scores(data):
            global top_scores
            top_scores = data

        def trigger_github_action(name, score):
            token = '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'  # Keep this secret!
            headers = {
                'Authorization': f'token {token}',
                'Accept': 'application/vnd.github.v3+json'
            }
            data = {
                'event_type': 'update-high-scores',
                'client_payload': {
                    'name': name,
                    'score': score
                }
            }
            window.fetch('https://api.github.com/repos/Jamie-Wilson-UL/No-Matter/dispatches', {
                'method': 'POST',
                'headers': headers,
                'body': window.JSON.stringify(data)
            }).then(
                lambda response: window.console.log("High score submitted")
            ).catch(
                lambda error: window.console.error(f"Error saving high scores: {error}")
            )

        document.bind("keydown", move_player)
        window.setInterval(update, 30)
        window.setInterval(enemy_shoot, 500)
        window.setInterval(toggle_flash_text, 1000)

        def animate_title_screen():
            if not game_started:
                draw_start_screen()
                window.requestAnimationFrame(lambda x: animate_title_screen())

        initialize_high_score()
        animate_title_screen()

        # Handle form submission
        def submit_name(event):
            global top_scores, showing_high_score_prompt, showing_final_score
            player_name = player_name_input.value.strip()
            if player_name:
                top_scores.append({"name": player_name, "score": score})
                top_scores.sort(key=lambda x: x["score"], reverse=True)
                top_scores = top_scores[:3]
                trigger_github_action(player_name, score)
                hide_high_score_prompt()
                if level > MAX_LEVELS:
                    showing_final_score = False
                    show_credits()
                else:
                    window.setTimeout(reset_game, 3000)

        submit_name_button.bind("click", submit_name)
    </script>
</body>
</html>
