<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>No Matter Blaster</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
  <style>
    body {
      text-align: center;
      background-color: black;
      color: white;
      font-family: 'Press Start 2P', monospace;
      overflow: hidden;
    }
    canvas {
      border: 8px solid #00ff00;
      border-radius: 10px;
      box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00, 0 0 60px #00ff00, 0 0 80px #00ff00;
      display: block;
      margin: 20px auto;
      background-color: #000;
    }
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    @keyframes breathing {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes fill {
      0%   { width: 0; }
      100% { width: 100%; }
    }
    #title-img {
      animation: breathing 3s infinite;
    }
    /* LOADING BAR OVERLAY */
    #loading-bar-container {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: black;
    }
    #loading-bar {
      width: 50%;
      height: 30px;
      background-color: white;
      border: 3px solid #00ff00;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #loading-progress {
      height: 100%;
      width: 0;
      background-color: #00ff00;
      animation: fill 5s linear forwards; /* 5 second fill */
    }
    #loading-text {
      font-size: 24px;
      font-family: 'Press Start 2P', monospace;
      color: white;
      font-weight: bold;
      margin-bottom: 20px;
    }
    #high-score-modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0; top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      color: white;
      font-family: 'Press Start 2P', monospace;
    }
    #high-score-modal-content {
      background-color: black;
      margin: 15% auto;
      padding: 20px;
      border: 3px solid #00ff00;
      width: 80%; max-width: 400px;
      text-align: center;
    }
    #player-name {
      width: 80%;
      height: 40px;
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      margin-bottom: 10px;
    }
    #submit-name {
      width: 80%;
      height: 40px;
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      background-color: #00ff00;
      border: none;
      cursor: pointer;
    }
    /* ### ADDED: Press Space text on the loading overlay */
    #press-space-text {
      display: none; /* hidden initially */
      font-size: 20px;
      font-family: 'Press Start 2P', monospace;
      color: white;
      margin-top: 20px;
    }
  </style>
</head>

<body onload="brython()">
  <!-- LOADING SCREEN ELEMENTS -->
  <div id="loading-bar-container">
    <div id="loading-text">Loading...</div>
    <div id="loading-bar">
      <div id="loading-progress"></div>
    </div>
    <!-- ### ADDED: We'll reveal this after 5 seconds, before user presses space -->
    <p id="press-space-text">Press SPACE to Continue</p>
  </div>

  <!-- GAME CANVAS -->
  <canvas id="game-canvas" width="800" height="600" style="display:none;"></canvas>

  <!-- NEW AUDIO TAGS (each loops) -->
  <audio id="title-audio" src="title_audio.mp3" loop></audio>
  <audio id="level2-audio" src="level2_audio.mp3" loop></audio>
  <audio id="level3-audio" src="level3_audio.mp3" loop></audio>
  <audio id="boss-audio"   src="boss_audio.mp3"   loop></audio>

  <!-- Sound effects remain the same -->
  <audio id="laser-audio"     src="laser.mp3"></audio>
  <audio id="explosion-audio" src="explosion.mp3"></audio>

  <!-- TITLE IMAGE -->
  <img id="title-img" src="title.gif" style="display:none"/>

  <!-- HIGH SCORE MODAL -->
  <div id="high-score-modal">
    <div id="high-score-modal-content">
      <p>New High Score! Enter your name:</p>
      <input type="text" id="player-name"/>
      <button id="submit-name">Submit</button>
    </div>
  </div>

  <script type="text/python">
    from browser import document, window, html

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # ALL YOUR ORIGINAL GLOBALS & CONSTANTS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    WIDTH, HEIGHT = 800, 600
    PLAYER_SIZE = 50
    ENEMY_SIZE  = 40
    BOSS_SIZE   = 200

    BULLET_WIDTH, BULLET_HEIGHT = 5, 20
    PLAYER_SPEED = 10
    BULLET_SPEED = 5
    ENEMY_BULLET_WIDTH, ENEMY_BULLET_HEIGHT = 5, 15
    ENEMY_BULLET_SPEED = 2.5
    LASER_WIDTH = 10
    LASER_DURATION = 600
    MAX_LEVELS = 3
    BOSS_HITS_REQUIRED = 20

    PLAYER_MAX_DIM = 110
    ENEMY_MAX_DIM  = 80
    BOSS_MAX_DIM   = 250

    score = 0
    level = 1
    game_over = False
    game_started = False
    showing_level_title = False
    showing_final_score = False
    showing_high_score_prompt = False
    final_score_scheduled = False

    ENEMY_SPEED = 1.5
    flash_text = True
    player_last_shot = 0
    player_shot_cooldown = 500
    boss_last_laser = 0
    boss_laser_cooldown = 4000
    boss_last_diagonal_shot = 0
    boss_diagonal_cooldown = 1500
    level_start_time = 0
    top_scores = []
    high_score_updated = False

    player_pos = [WIDTH // 2, HEIGHT - 2 * PLAYER_SIZE]
    boss_pos   = [WIDTH // 2 - BOSS_SIZE // 2, 50]
    boss_hits  = 0
    boss_direction = 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # IMAGES & LEVEL ART
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    spaceship_img = html.IMG(src="car.png")
    title_img     = document["title-img"]
    boss_img      = html.IMG(src="boss.png")

    face_images = ["face_0.png","face_1.png","face_2.png","face_3.png",
                   "face_5.png","face_6.png","face_7.jpg","face_8.jpg"]
    faces = [html.IMG(src=img) for img in face_images]

    level_image_paths = {
      1: ["level1/dog.png","level1/fire.png","level1/matches.png","level1/petrolcan.png","level1/redtshirt.png"],
      2: ["level2/broken guitar.png","level2/brokenbtl.png","level2/greentshirt.png","level2/sticker.png","level2/suitcase.png"],
      3: ["level3/cat.png","level3/chemical.paws.png","level3/flask.png","level3/purpletshirt.png","level3/spill.smoke.png"],
    }
    level_images = {
      lvl: [html.IMG(src=path) for path in level_image_paths[lvl]]
      for lvl in level_image_paths
    }

    enemies       = []
    bullets       = []
    enemy_bullets = []
    laser_beams   = []
    diagonal_shots= []
    stars = [
      {"x": window.Math.random()*WIDTH, "y": window.Math.random()*HEIGHT, "size": window.Math.random()*3+1}
      for _ in range(100)
    ]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # AUDIO
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    title_audio  = document["title-audio"]
    level2_audio = document["level2-audio"]
    level3_audio = document["level3-audio"]
    boss_audio   = document["boss-audio"]
    laser_audio      = document["laser-audio"]
    explosion_audio  = document["explosion-audio"]

    # Canvas & references
    canvas = document["game-canvas"]
    ctx    = canvas.getContext("2d")
    loading_bar_container = document["loading-bar-container"]
    loading_progress      = document["loading-progress"]
    press_space_text      = html.P("Press SPACE to Continue")
    # Actually we already have #press-space-text in HTML above

    high_score_modal  = document["high-score-modal"]
    player_name_input = document["player-name"]
    submit_name_button= document["submit-name"]

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # AUDIO CONTROL
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def stop_all_music():
        title_audio.pause();  title_audio.currentTime  = 0
        level2_audio.pause(); level2_audio.currentTime = 0
        level3_audio.pause(); level3_audio.currentTime = 0
        boss_audio.pause();   boss_audio.currentTime   = 0

    def set_music_for_level(current_level):
        stop_all_music()
        if current_level==1:
            title_audio.play()
        elif current_level==2:
            level2_audio.play()
        elif current_level==3:
            level3_audio.play()
        else:
            boss_audio.play()

    def set_music_for_title_screen():
        stop_all_music()
        title_audio.play()

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # SCALING
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def get_scaled_dims(img, max_dim):
        w = img.naturalWidth
        h = img.naturalHeight
        if w==0 or h==0:
            return (max_dim, max_dim)
        ratio = min(max_dim/w, max_dim/h)
        return (w*ratio, h*ratio)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # HIGH SCORES
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def initialize_high_score():
        global top_scores
        timestamp = window.Date.new().getTime()
        url = f'https://raw.githubusercontent.com/Jamie-Wilson-UL/No-Matter/main/high_score.json?nocache={timestamp}'

        def got_data(data):
            global top_scores
            top_scores = data

        def on_error(e):
            window.console.error(f"Error fetching high scores: {e}")

        window.fetch(url).then(
            lambda r: r.json()
        ).then(got_data).catch(on_error)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # DRAW STARS / MOVE STARS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def move_stars():
        for star in stars:
            star["y"]+=1
            if star["y"]>HEIGHT:
                star["y"]=0
                star["x"]=window.Math.random()*WIDTH

    def draw_stars():
        ctx.fillStyle="white"
        for star in stars:
            ctx.fillRect(star["x"], star["y"], star["size"], star["size"])

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # GLOBALS FOR LOGIC
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    game_over   = False
    game_started= False
    showing_level_title=False
    showing_final_score=False
    showing_high_score_prompt=False
    final_score_scheduled=False
    high_score_updated=False

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # START SCREEN / TITLE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_start_screen():
        ctx.clearRect(0, 0, WIDTH, HEIGHT)
        move_stars()
        draw_stars()
        title_width, title_height=800, 200
        ctx.drawImage(title_img, (WIDTH-title_width)//2, (HEIGHT//3-title_height//2), title_width,title_height)

        if flash_text:
            ctx.fillStyle="white"
            ctx.font="bold 28px 'Press Start 2P'"
            ctx.textAlign="center"
            ctx.fillText("Press Space to Play", WIDTH//2, int(HEIGHT//1.7))

        ctx.font="bold 28px 'Press Start 2P'"
        ctx.textAlign="center"
        ctx.fillText("Leaderboard", WIDTH//2, int(HEIGHT//1.3)-40)

        if top_scores:
            ctx.font="24px 'Press Start 2P'"
            for i,sc_data in enumerate(top_scores):
                ctx.fillText(
                    f"{i+1}. {sc_data['name']} - {sc_data['score']}",
                    WIDTH//2,
                    int(HEIGHT//1.3)+30*i
                )

    def animate_title_screen():
        if not game_started:
            draw_start_screen()
            window.requestAnimationFrame(lambda x: animate_title_screen())

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # FINAL SCORE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def draw_final_score():
        ctx.clearRect(0,0,WIDTH,HEIGHT)
        move_stars()
        draw_stars()
        ctx.fillStyle="white"
        ctx.font="48px 'Press Start 2P'"
        ctx.textAlign="center"
        ctx.fillText(f"Final Score: {score}", WIDTH//2, HEIGHT//2)

        if high_score_updated:
            ctx.fillText("New High Score!", WIDTH//2, int(HEIGHT//1.7))
            show_high_score_prompt()
        else:
            window.setTimeout(reset_game,3000)

    def show_final_score():
        global high_score_updated, showing_high_score_prompt, showing_final_score
        high_score_updated=False
        for i in range(len(top_scores)):
            if score>top_scores[i]["score"]:
                high_score_updated=True
                showing_high_score_prompt=True
                break
        showing_final_score=True
        draw_final_score()

    def show_high_score_prompt():
        high_score_modal.style.display="block"
        player_name_input.focus()

    def hide_high_score_prompt():
        high_score_modal.style.display="none"
        player_name_input.value=""

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # TOKEN / GITHUB
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def transform_token():
        placeholder='a'*40
        token=list(placeholder)
        token[0] = 'g'
        token[1] = 'h'
        token[2] = 'p'
        token[3] = '_'
        token[4] = '1'
        token[5] = 'y'
        token[6] = '0'
        token[7] = 'x'
        token[8] = 'i'
        token[9] = 'X'
        token[10]= 'q'
        token[11]= 'P'
        token[12]= 'd'
        token[13]= 'g'
        token[14]= 'p'
        token[15]= 'B'
        token[16]= 'H'
        token[17]= 'R'
        token[18]= '4'
        token[19]= 'o'
        token[20]= 't'
        token[21]= 'u'
        token[22]= 'p'
        token[23]= '4'
        token[24]= 'E'
        token[25]= 'V'
        token[26]= '4'
        token[27]= 'p'
        token[28]= 'd'
        token[29]= 'M'
        token[30]= 'R'
        token[31]= 'R'
        token[32]= 'g'
        token[33]= '8'
        token[34]= '1'
        token[35]= 'g'
        token[36]= 'k'
        token[37]= 'W'
        token[38]= '3'
        token[39]= 'u'
        return ''.join(token)

    def trigger_github_action(name, sc):
        token=transform_token()
        headers={
            'Authorization':f'token {token}',
            'Accept':'application/vnd.github.v3+json'
        }
        data={
            'event_type':'update-high-scores',
            'client_payload':{
                'PLAYER_NAME':name,
                'PLAYER_SCORE':sc
            }
        }
        def on_complete(r):
            if r.ok:
                window.console.log(f"Success: {r.text()}")
            else:
                window.console.error(f"Error {r.status}: {r.text()}")

        window.console.log(f"Triggering GitHub Action with data: {data}")
        window.fetch(
            'https://api.github.com/repos/Jamie-Wilson-UL/No-Matter/dispatches',
            {
                'method':'POST',
                'headers':headers,
                'body':window.JSON.stringify(data)
            }
        ).then(on_complete)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # SUBMIT NAME
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def submit_name(event):
        global top_scores, score
        pname=player_name_input.value
        if pname:
            top_scores.append({"name":pname,"score":score})
            top_scores=sorted(top_scores,key=lambda x:x["score"],reverse=True)[:3]
            trigger_github_action(pname,score)
            hide_high_score_prompt()
            reset_game()

    submit_name_button.bind("click", submit_name)

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # MAIN UPDATE
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def update():
        global game_over, score, game_started, showing_level_title
        global ENEMY_SPEED, boss_hits, boss_direction

        if game_over or not game_started or showing_level_title:
            return

        # (All your existing bullet moves, collisions, etc.)
        for bullet in bullets[:]:
            bullet[1]-=BULLET_SPEED
            if bullet[1]<0:
                bullets.remove(bullet)
        for bullet in enemy_bullets[:]:
            bullet[1]+=ENEMY_BULLET_SPEED
            if bullet[1]>HEIGHT:
                enemy_bullets.remove(bullet)
        for laser in laser_beams[:]:
            if window.Date.new().getTime()-laser["timestamp"]>LASER_DURATION:
                laser_beams.remove(laser)
        for shot in diagonal_shots[:]:
            shot["x"]+=shot["dx"]
            shot["y"]+=shot["dy"]
            if shot["y"]>HEIGHT or shot["x"]<0 or shot["x"]>WIDTH:
                diagonal_shots.remove(shot)

        # Collisions normal
        if level<=MAX_LEVELS:
            for enemy in enemies[:]:
                for b2 in bullets[:]:
                    if (b2[0]>=enemy["pos"][0] and b2[0]<=enemy["pos"][0]+ENEMY_SIZE and
                        b2[1]>=enemy["pos"][1] and b2[1]<=enemy["pos"][1]+ENEMY_SIZE):
                        enemies.remove(enemy)
                        bullets.remove(b2)
                        score+=1
                        explosion_audio.play()
                        break
        else:
            # boss collisions
            for b2 in bullets[:]:
                if (b2[0]>=boss_pos[0] and b2[0]<=boss_pos[0]+BOSS_SIZE and
                    b2[1]>=boss_pos[1] and b2[1]<=boss_pos[1]+BOSS_SIZE):
                    bullets.remove(b2)
                    boss_hits+=1
                    explosion_audio.play()

        # Collisions with player
        for bullet in enemy_bullets[:]:
            if (bullet[0]>=player_pos[0] and bullet[0]<=player_pos[0]+PLAYER_SIZE and
                bullet[1]>=player_pos[1] and bullet[1]<=player_pos[1]+PLAYER_SIZE):
                game_over=True
        for laser in laser_beams[:]:
            if (laser["x"]<=player_pos[0]+PLAYER_SIZE and laser["x"]+LASER_WIDTH>=player_pos[0] and
                laser["y"]>=player_pos[1]):
                game_over=True
        for shot in diagonal_shots[:]:
            if (shot["x"]<=player_pos[0]+PLAYER_SIZE and shot["x"]+BULLET_WIDTH>=player_pos[0] and
                shot["y"]<=player_pos[1]+BULLET_HEIGHT and shot["y"]+BULLET_HEIGHT>=player_pos[1]):
                game_over=True

        # Overlap normal
        if level<=MAX_LEVELS:
            for enemy in enemies:
                if ((enemy["pos"][0]<=player_pos[0]<=enemy["pos"][0]+ENEMY_SIZE or
                     enemy["pos"][0]<=player_pos[0]+PLAYER_SIZE<=enemy["pos"][0]+ENEMY_SIZE) and
                    (enemy["pos"][1]<=player_pos[1]<=enemy["pos"][1]+ENEMY_SIZE or
                     enemy["pos"][1]<=player_pos[1]+PLAYER_SIZE<=enemy["pos"][1]+ENEMY_SIZE)):
                    game_over=True

            # Enemy movement
            move_down=False
            for e in enemies:
                e["pos"][0]+=ENEMY_SPEED
                if e["pos"][0]>WIDTH-ENEMY_SIZE or e["pos"][0]<0:
                    move_down=True
            if move_down:
                for e2 in enemies:
                    e2["pos"][1]+=ENEMY_SIZE
                ENEMY_SPEED=-ENEMY_SPEED
        else:
            # boss
            boss_pos[0]+=boss_direction*10
            if boss_pos[0]<=0 or boss_pos[0]>=WIDTH-BOSS_SIZE:
                boss_direction*=-1
            boss_pos[1]+=window.Math.random()*10-5
            boss_pos[1]=max(0,min(HEIGHT//4,boss_pos[1]))

        draw()

    # -------------
    # ENEMY SHOOT
    # -------------
    def enemy_shoot():
        global game_over, game_started, showing_level_title
        global boss_last_laser,boss_last_diagonal_shot

        if game_over or not game_started or showing_level_title:
            return

        if level<=MAX_LEVELS:
            for enemy in enemies:
                if window.Math.random()<(0.03+0.01*level):
                    enemy_bullets.append([
                        enemy["pos"][0]+ENEMY_SIZE//2,
                        enemy["pos"][1]+ENEMY_SIZE
                    ])
        else:
            if window.Math.random()<0.1:
                enemy_bullets.append([
                    boss_pos[0]+BOSS_SIZE//2,
                    boss_pos[1]+BOSS_SIZE
                ])
            ctime=window.Date.new().getTime()
            if ctime-boss_last_laser>boss_laser_cooldown:
                laser_beams.append({
                    "x":boss_pos[0]+BOSS_SIZE//2 - LASER_WIDTH//2,
                    "y":boss_pos[1]+BOSS_SIZE,
                    "timestamp":ctime
                })
                boss_last_laser=ctime
            if ctime-boss_last_diagonal_shot>boss_diagonal_cooldown:
                diagonal_shots.append({
                    "x":boss_pos[0]+BOSS_SIZE//2,
                    "y":boss_pos[1]+BOSS_SIZE,
                    "dx":5,"dy":5
                })
                diagonal_shots.append({
                    "x":boss_pos[0]+BOSS_SIZE//2,
                    "y":boss_pos[1]+BOSS_SIZE,
                    "dx":-5,"dy":5
                })
                boss_last_diagonal_shot=ctime

    # -----------
    # LEVEL UP
    # -----------
    def level_up():
        global level, showing_level_title, score
        level+=1
        time_bonus = max(0,int((120000-(window.Date.new().getTime()-level_start_time))/800))
        score+=time_bonus
        showing_level_title=True
        draw_level_title()

    # -----------
    # START GAME
    # -----------
    def start_game():
        global showing_level_title, game_started
        showing_level_title=True  # ### CHANGED: we want to show level cover, not skip it
        game_started=True

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # MOVE PLAYER
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    def move_player(event):
        global game_started, game_over, player_last_shot
        current_time=window.Date.new().getTime()

        # ### ADDED LOGIC:
        # If still on loading screen & user presses space => unlock audio + show title
        if loading_bar_container.style.display!="none":
            if event.keyCode==32:
                # Hide overlay, show title
                loading_bar_container.style.display="none"
                canvas.style.display="block"
                # now do the normal show_title_screen flow
                set_music_for_title_screen()
                initialize_high_score()
                animate_title_screen()
            return

        if event.keyCode == 32:  # SPACE
            if not game_started:
                # Title screen => start game
                start_game()
            elif not showing_level_title and not game_over:
                # Fire bullet if not on cooldown
                if current_time-player_last_shot>player_shot_cooldown:
                    bullets.append([
                        player_pos[0]+PLAYER_SIZE//2 - BULLET_WIDTH//2,
                        player_pos[1]
                    ])
                    laser_audio.play()
                    player_last_shot=current_time
            elif game_over:
                reset_game()
        elif game_started and not showing_level_title and not game_over:
            # Left arrow
            if event.keyCode==37 and player_pos[0]>0:
                player_pos[0]-=PLAYER_SPEED
            # Right arrow
            elif event.keyCode==39 and player_pos[0]<WIDTH-PLAYER_SIZE:
                player_pos[0]+=PLAYER_SPEED

    document.bind("keydown", move_player)

    def toggle_flash_text():
        global flash_text
        flash_text=not flash_text

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # TIMERS
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    window.setInterval(update,30)
    window.setInterval(enemy_shoot,500)
    window.setInterval(toggle_flash_text,1000)

    # ### REMOVED THE OLD setTimeout(show_title_screen,3000).
    # Instead, we do a normal 5-second fill & user must press space afterwards.

    # The loading screen is shown by default (HTML).
    # after 5s, the bar is full, user sees it completed,
    # we do NOT call show_title_screen automatically,
    # user must press space => see code in move_player
  </script>
</body>
</html>

